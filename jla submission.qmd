---
title: 'Příspěvek na MME 2023'
abstract: 
  'Abstract text goes here. This template provides necessary styles and examples to produce valid paper for the international conference on Mathematical Methods in Economics organized by Czech Society for Operations Research and collaborating institutions. The submitted paper cannot be longer than six pages including results, figures and references.'
keywords: 
  'Battery electric vehicles, Hybrid vehicles, Technology adoption and diffusion, Czechia'
JEL:
    'zde budiž jel klasifikace'
AMS:
    'zde budiž ams klasifikace'
author: 'Jindra Lacko'
affiliation: 'Vysoká škola ekonomická v Praze / Katedra Ekonometrie'
email: 'jindra.lacko@vse.cz'
format: 
  pdf:
    keep-tex: true
knitr:
  opts_chunk: 
    fig.showtext: true
    dev: cairo_pdf
execute: 
  eval: true
  echo: false
  message: false
  warning: false
template:
  'template_mme2020.tex'
bibliography:
  'references.bib'
csl: 
  'ieee.csl'
---

```{r setup}
#| echo: FALSE
#| eval: TRUE

# fce na pěkná procenta
prettyprc <- function(x) {
  res <- (100 * x) %>%
    round(2) %>%
    format(scientific = F, nsmall = 2) %>%
    paste0("%")

  res
}

prettynum <- function(x) {
  
  prettyNum(x, big.mark = " ")
  
}

# https://stackoverflow.com/questions/21708764/cannot-change-text-size-in-regsubsets-plot
plot_regsubsets_mod <- function (x, labels = obj$xnames, main = NULL, scale = c("bic", 
    "Cp", "adjr2", "r2"), col = gray(seq(0, 0.9, length = 10)), 
    ...) 
{
    obj <- x
    lsum <- summary(obj)
    par(mar = c(7, 5, 6, 3) + 0.1)
    nmodels <- length(lsum$rsq)
    np <- obj$np
    propscale <- FALSE
    sscale <- pmatch(scale[1], c("bic", "Cp", "adjr2", "r2"), 
        nomatch = 0)
    if (sscale == 0) 
        stop(paste("Unrecognised scale=", scale))
    if (propscale) 
        stop(paste("Proportional scaling only for probabilities"))
    yscale <- switch(sscale, lsum$bic, lsum$cp, lsum$adjr2, lsum$rsq)
    up <- switch(sscale, -1, -1, 1, 1)
    index <- order(yscale * up)
    colorscale <- switch(sscale, yscale, yscale, -log(pmax(yscale, 
        1e-04)), -log(pmax(yscale, 1e-04)))
    image(z = t(ifelse(lsum$which[index, ], colorscale[index], 
        NA + max(colorscale) * 1.5)), xaxt = "n", yaxt = "n", 
        x = (1:np), y = 1:nmodels, xlab = "", ylab = scale[1], 
        col = col)
    laspar <- par("las")
    on.exit(par(las = laspar))
    par(las = 2)
    axis(1, at = 1:np, labels = labels, ...) # I modified this line
    axis(2, at = 1:nmodels, labels = signif(yscale[index], 2))
    if (!is.null(main)) 
        title(main = main)
    box()
    invisible(NULL)
}

library(RCzechia)
library(dplyr)
library(dbplyr)
library(tidyr)
library(ggplot2)
library(forcats)
library(knitr)
library(kableExtra)

con <- DBI::dbConnect(RSQLite::SQLite(), "~/Documents/elektroauta/data/auta.sqlite") # připojit databázi

registrace <- tbl(con, 'registrace_pracovni') %>% 
  filter(rok_registrace >= '2019' 
         & rok_registrace <= '2022'
         & kategorie == "M1")

```

# Introduction

Reducing CO~2~ emissions significantly in comparison to 1990 levels is a target of both global @paris16  and regional initiatives @green_deal19. A key factor for achieving this aim is reducing the volume of CO~2~ emissions from transportation @proposal21. This is in line with the contribution transportation related emissions have made to the current stock of CO~2~ in the Earth's atmosphere @cwatch_dex.

In order to achieve these aims it will be necessary to significantly reduce the volume of active Interal Combustion Engine (ICE) vehicles on EU roads. While alternatives to personal vehicle ownership such as mass transit and bicycling are certain to be a part of the solution it is unlikely that the current level of vehicle ownership (over 6 million personal vehicles are registered in the Czech Republic alone, a country of 10 million inhabitants @slaba_houst22) could be feasibly reduced to zero.

As a consequence any plan to reduce and / or eliminate ICE personal vehicle ownership and use must include introducing of alternatives, such as Electric Vehicles (EV's).




# Methodology


```{r summary}

rocne <- registrace %>% 
  group_by(rok_registrace, typ_obchodu, typ)  %>%
  summarise(pocet = n()) %>% 
  collect() %>% 
  pivot_wider(names_from = typ, values_from = pocet, values_fill = 0) %>% 
  summarise(
    spalovaci = sum(spalovací),
    elektro = sum(elektro),
    hybrid = sum(hybrid),
    celkem = spalovaci + elektro + hybrid,
    pct_elektro = elektro / celkem,
    pct_hybrid = hybrid / celkem,
    pct_ev = pct_elektro + pct_hybrid
            ) %>% 
  ungroup()
 
```

The data were collected from the Czech Ministry of Transport Open Data @registr monthly snapshots. For the purpose of our analysis the only registrations from years `r min(rocne$rok_registrace)` to `r max(rocne$rok_registrace)` were used. 

During the period in question total of `r prettynum(sum(rocne$spalovaci) + sum(rocne$elektro) + sum(rocne$hybrid))` personal vehicles were registered, of which `r prettynum(sum(rocne$elektro) + sum(rocne$hybrid))` could be considered EV's (`r prettynum(sum(rocne$elektro))` battery operated EVs and `r prettynum(sum(rocne$hybrid))` hybrid EVs).

Majority of the EV registrations come from the non-retail segment (vehicle registrations by companies) - `r prettynum(sum(subset(rocne, typ_obchodu == "non-retail")$elektro) + sum(subset(rocne, typ_obchodu == "non-retail")$hybrid))` registrations. Compared to this the retail segment (vehicle registrations by natural persons) had only `r prettynum(sum(subset(rocne, typ_obchodu == "retail")$elektro) + sum(subset(rocne, typ_obchodu == "retail")$hybrid))` registrations, which is `r prettyprc((sum(subset(rocne, typ_obchodu == "retail")$elektro) + sum(subset(rocne, typ_obchodu == "retail")$hybrid)) / (sum(rocne$elektro)+sum(rocne$hybrid)))` of total EV registrations over the period in consideration.

The for a detailed breakdown over brands and models see @tbl-models.


```{r models}
#| label: tbl-models
#| tbl-cap: Model Breakdown

model_breakdown <- registrace %>% 
  filter(typ != "spalovací") %>% 
  select(typ_obchodu, tovarni_znacka, obchodni_oznaceni, vin) %>% 
  collect()

vyznamne_znacky <- model_breakdown %>%
  group_by(tovarni_znacka) %>% 
  tally() %>%
  filter(n > 50) %>% 
  pull(tovarni_znacka)

model_breakdown <- model_breakdown %>% 
  mutate(mod_znacka = case_when(tovarni_znacka %in% vyznamne_znacky ~ tovarni_znacka,
                                T ~ "other brands")) %>% 
  mutate(mod_znacka = fct_infreq(mod_znacka)) %>% 
  mutate(mod_znacka = fct_relevel(mod_znacka, "other brands", after = Inf)) %>% 
  pivot_wider(names_from = typ_obchodu, 
              values_from = vin,
              values_fn = list(vin = length),
              values_fill = 0) %>% 
  mutate(mod_oznaceni = case_when(retail + `non-retail` < 15 ~ "other models",
                                  !mod_znacka %in% vyznamne_znacky ~ "other models",
                                  TRUE ~ obchodni_oznaceni)) %>% 
  group_by(mod_znacka, mod_oznaceni) %>% 
  summarise(retail = sum(retail),
            non_retail = sum(`non-retail`)) %>% 
  arrange(desc(retail + non_retail), .by_group = T) %>% 
  bind_rows(tibble(mod_znacka = '',
                   mod_oznaceni = '',
                   retail = sum(.$retail),
                   non_retail = sum(.$non_retail))) %>% 
  mutate(retail = prettynum(retail),
         non_retail = prettynum(non_retail))
  
model_breakdown %>%   
  kable(format = "latex",
        booktabs = T,
        align = c("l", "l", "r", "r"),
        col.names = c("Brand", "Model", "Retail", "Non-Retail"),
        linesep = '') %>% 
  kable_styling(full_width = F,
                latex_options = "hold_position") %>% 
  row_spec(0, bold = T, align = 'c') %>% 
  row_spec(nrow(model_breakdown)-1, hline_after = T)

```

In order to focus on end consumer activity we considered only personal vehicles (category M1) registered by natural persons (retail registrations). While electrification of corporate fleets is expected to contribute to the overall reduciton of transport CO~2~ emissions the behaviour of corporate fleets and vehicles under leasing contracts is a separate problem, infeasible to model based on local socioeconomic variables.

For an illustration consider map of Retail vs. Non-Retail EV penetration (@fig-retail-nonretail), noting the high penetration of EV registrations in Mladá Boleslav and Vrchlabí; these can be explained better as location of production hubs of Škoda Auto than by socioeconomic factors.

```{r mapa-penetrace}
#| label: fig-retail-nonretail
#| fig-cap: Non-retail vs. Retail EV Penetration (log scale)
#| fig-align: center
#| fig-height: 4
#| fig-pos: h
 
registrace_orp <- registrace %>% 
  group_by(KOD_ORP, typ_obchodu, typ, vin) %>% 
  summarise(pocet = n()) %>% 
  collect() %>% 
  pivot_wider(names_from = typ, values_from = pocet, values_fill = 0) %>% 
  summarise(
    spalovaci = sum(spalovací),
    elektro = sum(elektro),
    hybrid = sum(hybrid),
    celkem = spalovaci + elektro + hybrid,
    pct_elektro = elektro / celkem,
    pct_hybrid = hybrid / celkem,
    pct_ev = pct_elektro + pct_hybrid
            ) %>% 
  ungroup()
  
orp_chart_src <- orp_polygony() %>% 
  inner_join(registrace_orp, by = c("KOD_ORP" = "KOD_ORP")) %>% 
  mutate(typ_obchodu = stringr::str_to_title(typ_obchodu))

ggplot(data = orp_chart_src) +
  geom_sf(aes(fill = pct_ev),
          color = NA) +
  scale_fill_viridis_c(trans = "log10",
                       labels = scales::percent) +
  facet_wrap(facets = "typ_obchodu",
             ncol = 2) +
  labs(title = "BEVs & Hybrids as share of vehicle registrations",
       caption = paste("M1 vehicle registrations over", min(rocne$rok_registrace), "–",
                       max(rocne$rok_registrace),
                       "\nsource: https://www.mdcr.cz/Statistiky")) +
  theme_void() +
  theme(legend.position="bottom",
        legend.title = element_blank(),
        plot.title = element_text(hjust = 0.5,
                                  margin = margin(0,0,15,0)),
        plot.caption = element_text(face = "italic"),
        legend.margin = margin(0,10,10,0)
        )

```



# Result 

Model vcelku vychází...

```{r}
#| label: fig-stepwise
#| fig-cap: Schwartz's information criterion / stepwise regression
#| fig-align: center
#| fig-height: 4
#| fig-width: 6.5
#| fig-pos: H

reg_src <- registrace %>% 
  filter(typ_obchodu == "retail") %>% 
  group_by(KOD_ORP, typ) %>% 
  summarise(pocet = count(vin)) %>% 
  collect() %>% 
  pivot_wider(names_from = typ, values_from = pocet, values_fill = 0) %>% 
  mutate(pct_spalovaci = spalovací / (spalovací + elektro + hybrid)) %>% 
  mutate(pct_friendly = 1 - pct_spalovaci) %>% 
  ungroup()

obecni_scitani <- czso::czso_get_table("SLDB-VYBER") %>% 
  filter(uzcis == 65 | uzkod == '3018') %>% 
  mutate(uzkod = ifelse(uzkod == '3018', '1000', uzkod)) %>% # Praha jako kraj >> Praha jako ORP
  # metodika = https://www.czso.cz/documents/10180/25233177/sldb2011_vou.xls
  select(KOD_ORP = uzkod, 
         celkem = vse1111, 
         muzi = vse1112,
         zeny = vse1113,
         svobodni = vse1121,
         zenati = vse1131,
         rozvedeni = vse1141,
         ovdoveli = vse1151,
         plus15 = vse2111, 
         vs15 = vse2181,
         zs15 = vse2131,
         ss15 = vse2151,
         deti = vse3121,
         teens = vse3131,
         twenties = vse3141,
         thirties = vse3151,
         fourties = vse3161,
         fifties = vse3171,
         six_lo = vse3181,
         six_hi = vse3191,
         seventies = vse31101,
         eighties = vse31111,
         cesi = vse4121,
         moravci = vse4131,
         slezane = vse4141,
         slovaci = vse4151,
         nemci = vse4161,
         polaci = vse4171,
         romove = vse4181,
         ukrajinci = vse4191,
         vietnamci = vse41101,
         bezverci = vse5121,
         katolici = vse5141,
         husite = vse5151,
         evangelici = vse5161,
         jehovisti = vse5171,
         pravoslavni = vse5181,
         ateisti = vse5191,
         ek_aktivni = vse6111,
         zamestnanci = vse6131,
         icari = vse6151,
         prdusi = vse6161,
         matky = vse6173,
         nezamestnani = vse6181,
         neprdusi = vse61101,
         studenti = vse61111) %>% 
  mutate(across(!KOD_ORP, as.numeric)) %>% # pro vše kromě KOD_ORP: text >> číslo
  mutate(pct_svobodni = svobodni / plus15, # svobodní z 15+ 
         pct_vs = vs15 / plus15, # vysokoškoláci z 15+
         pct_zs = zs15 / plus15, # základní z 15+
         pct_ss = ss15 / plus15, # středoškoláci z 15+
         pct_0_14 = deti / celkem, # děti ze všech
         pct_15_19 = teens / celkem, 
         pct_20_29 = twenties / celkem,
         pct_30_39 = thirties / celkem,
         pct_40_49 = fourties / celkem,
         pct_50_59 = fifties / celkem,
         pct_60_69 = (six_hi + six_lo) / celkem,
         pct_70_79 = seventies / celkem,
         pct_80_plus = eighties / celkem,
         pct_ceska = cesi / celkem,
         pct_moravska = moravci / celkem,
         pct_slezska = slezane / celkem,
         pct_slovenska = slovaci / celkem,
         pct_nemecka = nemci / celkem,
         pct_romska = romove / celkem,
         pct_ukrajinska = ukrajinci / celkem,
         pct_vietnamska = vietnamci / celkem,
         pct_vira_bez = bezverci / celkem,
         pct_katolici = katolici / celkem,
         pct_husite = husite / celkem,
         pct_evangelici = evangelici / celkem,
         pct_jehoviste = jehovisti / celkem,
         pct_pravoslavni = pravoslavni / celkem,
         pct_ateisti = ateisti / celkem,
         pct_aktivni = ek_aktivni / plus15, # ekonomicky aktivní z 15+ (děti nebrat!)
         pct_zam = zamestnanci / ek_aktivni,
         pct_ico = icari / ek_aktivni,
         pct_prduch = prdusi / ek_aktivni,
         pct_matek = matky / ek_aktivni,
         pct_nezam = nezamestnani / ek_aktivni,
         pct_neprduch = neprdusi / plus15,
         pct_studenti = studenti / plus15)

podklad <- RCzechia::orp_polygony() %>% 
  left_join(reg_src, by = 'KOD_ORP') %>% 
  left_join(obecni_scitani, by = 'KOD_ORP') %>% 
  select(pct_friendly, starts_with("pct")) %>% 
  select(-pct_spalovaci)

# optimalizace podle {leaps} / Cp & BIC
leaps_model <- leaps::regsubsets(pct_friendly ~ ., 
                  data = st_drop_geometry(podklad),
                  nvmax = 15,
                  nbest = 1)

plot_regsubsets_mod(leaps_model, scale="bic", cex.axis = 0.66)

```
```{r }
#| label: tbl-coeffs
#| tbl-cap: Regression Coefficients
#| fig-pos: H

reg_model <- lm(pct_friendly ~ pct_vs + pct_ss + pct_20_29 +
                  pct_30_39 + pct_40_49, 
                  data = st_drop_geometry(podklad))

coef(reg_model) %>% 
    kable(format = "latex",
        booktabs = T,
        align = c("r"),
        col.names = c("coefficient"),
        linesep = '') %>% 
  kable_styling(full_width = F,
                latex_options = "hold_position") %>% 
  row_spec(0, bold = T, align = 'c') 

```

On one hand th R^2^ statistic is `r prettynum(summary(reg_model)$r.squared)`, meaning our model does not explain *that* much of the variance observed. 

On the other hand F the statistic `r prettynum(summary(reg_model)$fstatistic["value"])`, indicating a highly significant relationship.

```{r moran-i}
library(sfdep)

podklad$resids <- reg_model$residuals
podklad$fitted <- reg_model$fitted.values

# původní hodnoty - raw
orig_moran <- global_moran_test(podklad$pct_friendly,
             nb = st_contiguity(podklad$geometry, queen = F),
             wt = st_weights(st_contiguity(podklad$geometry, queen = F)))

# residua po modelu
resids_moran <- global_moran_test(podklad$resids,
             nb = st_contiguity(podklad$geometry, queen = F),
             wt = st_weights(st_contiguity(podklad$geometry, queen = F)))

```

The original data of retail EV penetration showed high degree of spatial dependence, as measured by `r orig_moran$method`. The value of Moran's I statistic was `r orig_moran$statistic`, with p-value `r orig_moran$p.value`.

On the other hand residuals after condidering the socioeconimic predictors showed much less spatial dependence, with Moran's I `r resids_moran$statistic`, with p-value `r resids_moran$p.value`.

# Discussion

# Conclusion

# References

```{r finally}

DBI::dbDisconnect(con) # poslední zhasne...

```
